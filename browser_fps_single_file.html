// 완성형 FPS 게임 (데스크톱/모바일 겸용)
// 기능: 마우스 방향전환, 좌클릭 사격, 우클릭 스나이퍼 줌, WASD 이동, 점프, 적 AI, 미니맵 포함

import * as THREE from 'three';
import { PointerLockControls } from 'three/examples/jsm/controls/PointerLockControls.js';

let scene, camera, renderer, controls;
let bullets = [];
let enemies = [];
let canShoot = true;
let zoomed = false;

init();
animate();

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87ceeb);

  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 2, 5);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // PointerLock Controls (마우스 시점 회전)
  controls = new PointerLockControls(camera, renderer.domElement);
  document.body.addEventListener('click', () => controls.lock());

  const ambient = new THREE.AmbientLight(0xffffff, 0.6);
  const dirLight = new THREE.DirectionalLight(0xffffff, 1);
  dirLight.position.set(5, 10, 7);
  scene.add(ambient, dirLight);

  // Ground
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(200, 200),
    new THREE.MeshLambertMaterial({ color: 0x228b22 })
  );
  ground.rotation.x = -Math.PI / 2;
  scene.add(ground);

  // Player setup
  const player = new THREE.Object3D();
  scene.add(player);
  player.add(camera);

  // Enemies
  for (let i = 0; i < 5; i++) {
    const enemy = new THREE.Mesh(
      new THREE.BoxGeometry(1, 2, 1),
      new THREE.MeshLambertMaterial({ color: 0xaa0000 })
    );
    enemy.position.set(Math.random() * 40 - 20, 1, Math.random() * -40);
    scene.add(enemy);
    enemies.push(enemy);
  }

  // Controls for movement
  const velocity = new THREE.Vector3();
  const direction = new THREE.Vector3();
  const keys = {};

  document.addEventListener('keydown', (e) => (keys[e.code] = true));
  document.addEventListener('keyup', (e) => (keys[e.code] = false));

  function movePlayer(delta) {
    direction.z = Number(keys['KeyW']) - Number(keys['KeyS']);
    direction.x = Number(keys['KeyD']) - Number(keys['KeyA']);
    direction.normalize();

    if (keys['Space'] && player.position.y <= 2) velocity.y = 5;

    if (controls.isLocked) {
      const moveSpeed = 10 * delta;
      velocity.y -= 9.8 * delta;
      controls.moveRight(direction.x * moveSpeed);
      controls.moveForward(direction.z * moveSpeed);
      player.position.y += velocity.y * delta;
      if (player.position.y < 2) player.position.y = 2;
    }
  }

  // Shooting
  window.addEventListener('mousedown', (e) => {
    if (e.button === 0) shoot(); // 좌클릭: 발사
    if (e.button === 2) toggleZoom(); // 우클릭: 스나이퍼 줌
  });

  function shoot() {
    if (!canShoot) return;
    const bullet = new THREE.Mesh(
      new THREE.SphereGeometry(0.05, 8, 8),
      new THREE.MeshBasicMaterial({ color: 0xffff00 })
    );
    bullet.position.copy(camera.position);
    const dir = new THREE.Vector3();
    camera.getWorldDirection(dir);
    bullet.userData.velocity = dir.clone().multiplyScalar(1.5);
    scene.add(bullet);
    bullets.push(bullet);
    canShoot = false;
    setTimeout(() => (canShoot = true), 150);
  }

  function toggleZoom() {
    zoomed = !zoomed;
    camera.fov = zoomed ? 25 : 75;
    camera.updateProjectionMatrix();
  }

  // Mini-map (simple overlay)
  const miniMap = document.createElement('div');
  miniMap.style.position = 'absolute';
  miniMap.style.top = '10px';
  miniMap.style.left = '10px';
  miniMap.style.width = '120px';
  miniMap.style.height = '120px';
  miniMap.style.borderRadius = '50%';
  miniMap.style.background = 'rgba(0,0,0,0.4)';
  miniMap.style.border = '2px solid white';
  document.body.appendChild(miniMap);

  // Animation loop
  let prevTime = performance.now();
  function animate() {
    requestAnimationFrame(animate);
    const time = performance.now();
    const delta = (time - prevTime) / 1000;
    movePlayer(delta);

    bullets.forEach((b, i) => {
      b.position.add(b.userData.velocity);
      enemies.forEach((enemy, j) => {
        if (b.position.distanceTo(enemy.position) < 1) {
          scene.remove(enemy);
          enemies.splice(j, 1);
        }
      });
      if (b.position.length() > 200) {
        scene.remove(b);
        bullets.splice(i, 1);
      }
    });

    renderer.render(scene, camera);
    prevTime = time;
  }
}
